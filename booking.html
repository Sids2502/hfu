<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Service - HereForYou</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <header class="header">
        <nav class="navbar">
            <div class="nav-brand">
                <i class="fas fa-home"></i>
                <span>HereForYou</span>
            </div>
            <div class="nav-links">
                <a href="dashboard.html" class="nav-link">Dashboard</a>
                <button class="btn-secondary" onclick="window.history.back()">Back</button>
            </div>
        </nav>
    </header>

    <main>
        <div class="booking-container">
            <div class="booking-header">
                <h1>Book Your Service</h1>
                <p>Schedule your appointment with a verified professional</p>
            </div>

            <div class="booking-content">
                <!-- Professional Summary -->
                <div class="booking-summary">
                    <h3>Service Details</h3>
                    <div class="service-summary">
                        <div class="professional-info">
                            <div class="professional-avatar" id="professionalAvatar"></div>
                            <div>
                                <h4 id="professionalName"></h4>
                                <p id="serviceType"></p>
                                <div class="rating">
                                    <span id="ratingStars"></span>
                                    <span id="ratingText"></span>
                                </div>
                            </div>
                        </div>
                        <div class="service-price">
                            <span class="price-label">Starting from</span>
                            <span class="price-amount" id="hourlyRate"></span>
                        </div>
                    </div>
                </div>

                <!-- Booking Form -->
                <div class="booking-form-container">
                    <form id="bookingForm" class="booking-form">
                        <!-- Date Selection -->
                        <div class="form-section">
                            <h4><i class="fas fa-calendar"></i> Select Date</h4>
                            <div id="calendarContainer" class="calendar-container">
                                <div class="calendar-header">
                                    <h4 id="calendarMonthYear"></h4>
                                </div>
                                <div class="calendar-grid">
                                    <div class="calendar-day-header">Sun</div>
                                    <div class="calendar-day-header">Mon</div>
                                    <div class="calendar-day-header">Tue</div>
                                    <div class="calendar-day-header">Wed</div>
                                    <div class="calendar-day-header">Thu</div>
                                    <div class="calendar-day-header">Fri</div>
                                    <div class="calendar-day-header">Sat</div>
                                    <!-- Calendar days populated by JavaScript -->
                                </div>
                            </div>
                        </div>

                        <!-- Time Selection -->
                        <div class="form-section">
                            <h4><i class="fas fa-clock"></i> Select Time</h4>
                            <div id="timeSlotsContainer" class="time-slots-container">
                                <p class="text-center">Please select a date first</p>
                            </div>
                        </div>

                        <!-- Service Address -->
                        <div class="form-section">
                            <h4><i class="fas fa-map-marker-alt"></i> Service Address</h4>
                            <div class="form-group">
                                <label for="address">Full Address</label>
                                <textarea id="address" name="address" rows="3" required 
                                         placeholder="Enter your complete address including landmarks"></textarea>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="pincode">Pincode</label>
                                    <input type="text" id="pincode" name="pincode" required 
                                           placeholder="682001">
                                </div>
                                <div class="form-group">
                                    <label for="city">City</label>
                                    <input type="text" id="city" name="city" required>
                                </div>
                            </div>
                        </div>

                        <!-- Service Details -->
                        <div class="form-section">
                            <h4><i class="fas fa-tools"></i> Service Requirements</h4>
                            <div class="form-group">
                                <label for="serviceType">Type of Service</label>
                                <select id="serviceType" name="serviceType">
                                    <!-- Options will be populated by JavaScript -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="description">Problem Description</label>
                                <textarea id="description" name="description" rows="4" 
                                         placeholder="Describe the issue in detail to help the professional prepare better"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="urgency">Urgency Level</label>
                                <select id="urgency" name="urgency">
                                    <option value="normal">Normal</option>
                                    <option value="urgent">Urgent (Same day)</option>
                                    <option value="emergency">Emergency (ASAP)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Contact Information -->
                        <div class="form-section">
                            <h4><i class="fas fa-phone"></i> Contact Information</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="contactName">Contact Person</label>
                                    <input type="text" id="contactName" name="contactName" required 
                                           placeholder="Your name">
                                </div>
                                <div class="form-group">
                                    <label for="contactPhone">Phone Number</label>
                                    <input type="tel" id="contactPhone" name="contactPhone" required 
                                           placeholder="Your phone number">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="alternateContact">Alternate Contact (Optional)</label>
                                <input type="tel" id="alternateContact" name="alternateContact" 
                                       placeholder="Alternate phone number">
                            </div>
                        </div>

                        <!-- Payment Method -->
                        <div class="form-section">
                            <h4><i class="fas fa-credit-card"></i> Payment Method</h4>
                            <div class="payment-options">
                                <label class="payment-option">
                                    <input type="radio" name="paymentMethod" value="cash" checked>
                                    <div class="payment-card">
                                        <i class="fas fa-money-bill-wave"></i>
                                        <span>Cash After Service</span>
                                    </div>
                                </label>
                                <label class="payment-option">
                                    <input type="radio" name="paymentMethod" value="upi">
                                    <div class="payment-card">
                                        <i class="fas fa-mobile-alt"></i>
                                        <span>UPI Payment</span>
                                    </div>
                                </label>
                                <label class="payment-option">
                                    <input type="radio" name="paymentMethod" value="card">
                                    <div class="payment-card">
                                        <i class="fas fa-credit-card"></i>
                                        <span>Credit/Debit Card</span>
                                    </div>
                                </label>
                                <label class="payment-option">
                                    <input type="radio" name="paymentMethod" value="wallet">
                                    <div class="payment-card">
                                        <i class="fas fa-wallet"></i>
                                        <span>Digital Wallet</span>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Special Instructions -->
                        <div class="form-section">
                            <h4><i class="fas fa-info-circle"></i> Special Instructions</h4>
                            <div class="form-group">
                                <textarea id="instructions" name="instructions" rows="3" 
                                         placeholder="Any special instructions for the professional (e.g., gate code, parking instructions, etc.)"></textarea>
                            </div>
                        </div>

                        <!-- Terms and Conditions -->
                        <div class="form-section">
                            <div class="terms-section">
                                <label class="checkbox-container">
                                    <input type="checkbox" id="agreeTerms" required>
                                    <span class="checkmark"></span>
                                    I agree to the <a href="terms.html" target="_blank">Terms & Conditions</a> 
                                    and <a href="privacy.html" target="_blank">Privacy Policy</a>
                                </label>
                                <label class="checkbox-container">
                                    <input type="checkbox" id="agreeContact">
                                    <span class="checkmark"></span>
                                    I consent to being contacted by the professional for service coordination
                                </label>
                            </div>
                        </div>

                        <!-- Booking Summary -->
                        <div class="booking-final-summary">
                            <h4>Booking Summary</h4>
                            <div class="summary-item">
                                <span>Service:</span>
                                <span id="summaryService"></span>
                            </div>
                            <div class="summary-item">
                                <span>Professional:</span>
                                <span id="summaryProfessional"></span>
                            </div>
                            <div class="summary-item">
                                <span>Date & Time:</span>
                                <span id="summaryDateTime">Select date and time</span>
                            </div>
                            <div class="summary-item">
                                <span>Estimated Cost:</span>
                                <span id="summaryCost"></span>
                            </div>
                            <div class="summary-note">
                                <i class="fas fa-info-circle"></i>
                                <span>Final cost will be determined based on actual work required</span>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="form-actions">
                            <button type="button" class="btn-outline" onclick="window.history.back()">
                                Cancel
                            </button>
                            <button type="submit" class="btn-primary large">
                                <i class="fas fa-check"></i> Confirm Booking
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-bottom">
                <p>© 2025 HereForYou. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="script.js"></script>
    <script>
        // Initialize booking page
        document.addEventListener('DOMContentLoaded', async function() {
            // Check authentication
            if (!redirectToLogin()) return;

            const user = getCurrentUser();
            if (user) {
                document.getElementById('contactName').value = user.name || '';
                document.getElementById('contactPhone').value = user.phone || '';
                document.getElementById('city').value = user.city || 'Kochi';
            }

            const urlParams = new URLSearchParams(window.location.search);
            const professionalId = urlParams.get('professional');
            const serviceId = urlParams.get('service');

            if (!professionalId || !serviceId) {
                showNotification('Invalid professional or service selection', 'error');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
                return;
            }

            // Fetch professional details
            try {
                const serviceProvided = serviceMapping[serviceId] || serviceId;
                const city = user.city || 'kochi';
                const professionals = await getProfessionals(serviceProvided, city);
                const professional = professionals.find(p => p.professional_id === professionalId);
                
                if (!professional) {
                    showNotification('Professional not found', 'error');
                    setTimeout(() => {
                        window.location.href = `service-list.html?service=${serviceId}&location=${city}`;
                    }, 2000);
                    return;
                }

                const profData = transformProfessionalData(professional);
                document.getElementById('professionalAvatar').textContent = getInitials(profData.name);
                document.getElementById('professionalName').textContent = profData.name;
                
                // Update service type display
                const serviceTypeElement = document.querySelector('#serviceType').parentElement.previousElementSibling.querySelector('p');
                if (serviceTypeElement) {
                    serviceTypeElement.textContent = profData.specialties[0] || serviceId;
                }
                
                document.getElementById('ratingStars').textContent = '★'.repeat(Math.floor(profData.rating)) + '☆'.repeat(5 - Math.floor(profData.rating));
                document.getElementById('ratingText').textContent = `${profData.rating.toFixed(1)} (${profData.reviews} reviews)`;
                document.getElementById('hourlyRate').textContent = profData.hourlyRate;
                document.getElementById('summaryProfessional').textContent = profData.name;
                document.getElementById('summaryService').textContent = profData.specialties[0] || serviceMapping[serviceId] || serviceId;
                document.getElementById('summaryCost').textContent = `₹${professional.hourly_rate} - ₹${professional.hourly_rate + 200}`;

                // Populate service type dropdown
                const serviceTypeSelect = document.getElementById('serviceType');
                serviceTypeSelect.innerHTML = `
                    <option value="">Select service type</option>
                    ${profData.specialties.map(s => `<option value="${s}">${s}</option>`).join('')}
                    <option value="other">Other</option>
                `;
                
                // Set default selection
                if (profData.specialties.length > 0) {
                    serviceTypeSelect.value = profData.specialties[0];
                }
                
            } catch (error) {
                console.error('Error loading professional details:', error);
                showNotification('Error loading professional details', 'error');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
            }

            // Initialize form submission
            document.getElementById('bookingForm').addEventListener('submit', handleBookingSubmission);

            // Render calendar
            renderBookingCalendar();
        });

        function renderBookingCalendar() {
            const calendarContainer = document.getElementById('calendarContainer');
            if (!calendarContainer) return;

            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();

            document.getElementById('calendarMonthYear').textContent = today.toLocaleString('en-IN', { month: 'long', year: 'numeric' });

            const calendarGrid = document.querySelector('.calendar-grid');
            let calendarHTML = `
                <div class="calendar-day-header">Sun</div>
                <div class="calendar-day-header">Mon</div>
                <div class="calendar-day-header">Tue</div>
                <div class="calendar-day-header">Wed</div>
                <div class="calendar-day-header">Thu</div>
                <div class="calendar-day-header">Fri</div>
                <div class="calendar-day-header">Sat</div>
            `;

            // Add empty cells for previous month
            for (let i = 0; i < firstDay; i++) {
                calendarHTML += '<div class="calendar-day empty"></div>';
            }

            // Add days of current month
            for (let day = 1; day <= daysInMonth; day++) {
                const isPast = new Date(currentYear, currentMonth, day) < new Date(today.getFullYear(), today.getMonth(), today.getDate());
                const isToday = day === today.getDate();
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const classes = `calendar-day ${isPast ? 'past' : 'available'} ${isToday ? 'today' : ''}`;
                const onclick = isPast ? '' : `onclick="selectBookingDate('${dateStr}', ${day})"`;
                calendarHTML += `<div class="${classes}" data-date="${dateStr}" ${onclick}>${day}</div>`;
            }

            calendarGrid.innerHTML = calendarHTML;
        }

        function selectBookingDate(dateStr, day) {
            document.querySelectorAll('.calendar-day').forEach(dayEl => {
                dayEl.classList.remove('selected');
            });
            event.target.classList.add('selected');
            event.target.dataset.date = dateStr;
            renderBookingTimeSlots(day);
            updateBookingSummary();
        }

        function renderBookingTimeSlots(day) {
            const timeSlotsContainer = document.getElementById('timeSlotsContainer');
            if (!timeSlotsContainer) return;

            const timeSlots = [
                '09:00', '10:00', '11:00', '12:00',
                '14:00', '15:00', '16:00', '17:00', '18:00'
            ];

            timeSlotsContainer.innerHTML = `
                <h5>Available Time Slots for ${new Date().toLocaleString('en-IN', { month: 'long' })} ${day}</h5>
                <div class="time-slots">
                    ${timeSlots.map(time => `
                        <div class="time-slot" onclick="selectBookingTimeSlot('${time}')">
                            ${time}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function selectBookingTimeSlot(time) {
            document.querySelectorAll('.time-slot').forEach(slot => {
                slot.classList.remove('selected');
            });
            event.target.classList.add('selected');
            updateBookingSummary();
        }

        function updateBookingSummary() {
            const selectedDate = document.querySelector('.calendar-day.selected');
            const selectedTime = document.querySelector('.time-slot.selected');
            const serviceType = document.getElementById('serviceType').value;

            if (selectedDate && selectedTime) {
                document.getElementById('summaryDateTime').textContent = 
                    `${new Date(selectedDate.dataset.date).toLocaleDateString('en-IN', { month: 'short', day: 'numeric', year: 'numeric' })} at ${selectedTime.textContent}`;
            }

            if (serviceType) {
                document.getElementById('summaryService').textContent = 
                    serviceType.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
            }
        }

        // Inline styles (unchanged from original)
        const style = document.createElement('style');
        style.textContent = `
            .booking-container {
                max-width: 900px;
                margin: 0 auto;
                padding: 2rem 20px;
            }
            .booking-header {
                text-align: center;
                margin-bottom: 2rem;
            }
            .booking-header h1 {
                color: var(--text-primary);
                margin-bottom: 0.5rem;
            }
            .booking-content {
                display: grid;
                gap: 2rem;
            }
            .booking-summary {
                background: var(--white);
                padding: 2rem;
                border-radius: var(--border-radius);
                box-shadow: var(--shadow);
            }
            .service-summary {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-top: 1rem;
            }
            .professional-info {
                display: flex;
                align-items: center;
                gap: 1rem;
            }
            .service-price {
                text-align: right;
            }
            .price-label {
                display: block;
                font-size: 0.9rem;
                color: var(--text-secondary);
            }
            .price-amount {
                font-size: 1.5rem;
                font-weight: bold;
                color: var(--primary-color);
            }
            .booking-form-container {
                background: var(--white);
                border-radius: var(--border-radius);
                box-shadow: var(--shadow);
                overflow: hidden;
            }
            .form-section {
                padding: 2rem;
                border-bottom: 1px solid var(--border-color);
            }
            .form-section:last-child {
                border-bottom: none;
            }
            .form-section h4 {
                color: var(--text-primary);
                margin-bottom: 1.5rem;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }
            .form-section h4 i {
                color: var(--primary-color);
            }
            .form-row {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 1rem;
            }
            .calendar-container {
                background: var(--background-color);
                border-radius: 8px;
                padding: 1rem;
            }
            .calendar-header {
                text-align: center;
                margin-bottom: 1rem;
            }
            .calendar-grid {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                gap: 2px;
                background: var(--border-color);
                border-radius: 8px;
                overflow: hidden;
            }
            .calendar-day-header {
                background: var(--text-primary);
                color: var(--white);
                padding: 0.5rem;
                text-align: center;
                font-weight: bold;
                font-size: 0.8rem;
            }
            .calendar-day {
                aspect-ratio: 1;
                background: var(--white);
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: var(--transition);
                position: relative;
            }
            .calendar-day.empty {
                background: var(--background-color);
                cursor: default;
            }
            .calendar-day.past {
                background: #F8F9FA;
                color: var(--text-secondary);
                cursor: not-allowed;
            }
            .calendar-day.available {
                background: var(--white);
                color: var(--text-primary);
            }
            .calendar-day.available:hover {
                background: var(--primary-color);
                color: var(--white);
                transform: scale(1.05);
            }
            .calendar-day.unavailable {
                background: #F8D7DA;
                color: var(--error-color);
                cursor: not-allowed;
            }
            .calendar-day.selected {
                background: var(--primary-color);
                color: var(--white);
                font-weight: bold;
            }
            .calendar-day.today {
                border: 2px solid var(--secondary-color);
            }
            .time-slots-container {
                background: var(--background-color);
                border-radius: 8px;
                padding: 1rem;
            }
            .time-slots {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 0.5rem;
                margin-top: 1rem;
            }
            .time-slot {
                padding: 0.75rem;
                background: var(--white);
                border: 2px solid var(--border-color);
                border-radius: 8px;
                text-align: center;
                cursor: pointer;
                transition: var(--transition);
                font-weight: 500;
            }
            .time-slot:hover {
                border-color: var(--primary-color);
                background: var(--primary-color);
                color: var(--white);
            }
            .time-slot.selected {
                background: var(--primary-color);
                color: var(--white);
                border-color: var(--primary-color);
            }
            .no-slots {
                text-align: center;
                color: var(--text-secondary);
                font-style: italic;
                margin-top: 1rem;
            }
            .payment-options {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 1rem;
                margin-top: 1rem;
            }
            .payment-option {
                cursor: pointer;
            }
            .payment-option input[type="radio"] {
                display: none;
            }
            .payment-card {
                padding: 1rem;
                border: 2px solid var(--border-color);
                border-radius: 8px;
                text-align: center;
                transition: var(--transition);
                background: var(--white);
            }
            .payment-card i {
                font-size: 1.5rem;
                color: var(--primary-color);
                margin-bottom: 0.5rem;
                display: block;
            }
            .payment-option input[type="radio"]:checked + .payment-card {
                border-color: var(--primary-color);
                background: var(--primary-color);
                color: var(--white);
            }
            .payment-option input[type="radio"]:checked + .payment-card i {
                color: var(--white);
            }
            .terms-section {
                background: var(--background-color);
                padding: 1rem;
                border-radius: 8px;
            }
            .checkbox-container {
                display: flex;
                align-items: flex-start;
                cursor: pointer;
                font-size: 0.9rem;
                line-height: 1.4;
                margin-bottom: 1rem;
            }
            .checkbox-container:last-child {
                margin-bottom: 0;
            }
            .checkbox-container input[type="checkbox"] {
                width: auto;
                margin-right: 0.5rem;
                margin-top: 0.1rem;
                transform: scale(1.2);
            }
            .checkbox-container a {
                color: var(--primary-color);
                text-decoration: none;
            }
            .checkbox-container a:hover {
                text-decoration: underline;
            }
            .booking-final-summary {
                background: var(--background-color);
                padding: 1.5rem;
                border-radius: 8px;
                margin-top: 1rem;
            }
            .booking-final-summary h4 {
                margin-bottom: 1rem;
                color: var(--text-primary);
            }
            .summary-item {
                display: flex;
                justify-content: space-between;
                margin-bottom: 0.5rem;
                padding-bottom: 0.5rem;
                border-bottom: 1px solid var(--border-color);
            }
            .summary-item:last-of-type {
                border-bottom: none;
                font-weight: bold;
                color: var(--primary-color);
            }
            .summary-note {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                margin-top: 1rem;
                padding: 0.75rem;
                background: var(--white);
                border-radius: 6px;
                font-size: 0.9rem;
                color: var(--text-secondary);
            }
            .summary-note i {
                color: var(--secondary-color);
            }
            .form-actions {
                display: flex;
                gap: 1rem;
                justify-content: flex-end;
                padding: 2rem;
                background: var(--background-color);
            }
            .btn-primary.large {
                padding: 1rem 2rem;
                font-size: 1.1rem;
                font-weight: bold;
            }
            @media (max-width: 768px) {
                .booking-container {
                    padding: 1rem;
                }
                .service-summary {
                    flex-direction: column;
                    gap: 1rem;
                    text-align: center;
                }
                .form-row {
                    grid-template-columns: 1fr;
                }
                .payment-options {
                    grid-template-columns: 1fr;
                }
                .form-actions {
                    flex-direction: column;
                }
                .calendar-grid {
                    gap: 1px;
                }
                .time-slots {
                    grid-template-columns: repeat(2, 1fr);
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>